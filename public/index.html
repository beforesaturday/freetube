<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FreeTube</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #eee;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .tab {
      background-color: #333;
      color: #eee;
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      outline: none;
      margin: 0 5px;
      border-radius: 5px 5px 0 0;
      transition: background-color 0.3s ease;
    }
    .tab:hover {
      background-color: #555;
    }
    .tab.active {
      background-color: #1db954;
      color: #fff;
      font-weight: bold;
    }
    #videos {
      background-color: #222;
      padding: 15px;
      border-radius: 5px;
      min-height: 200px;
    }
    .video-item {
      border-bottom: 1px solid #444;
      padding: 10px 0;
    }
    .video-item:last-child {
      border-bottom: none;
    }
    .video-item p {
      margin: 5px 0;
    }
    video {
      max-width: 100%;
      margin-top: 8px;
      border-radius: 5px;
    }
    .delete-button {
      margin-top: 8px;
      background-color: #e74c3c;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    form#uploadForm {
      background-color: #222;
      padding: 20px;
      border-radius: 5px;
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    label {
      font-weight: bold;
    }
    input[type="text"], input[type="file"] {
      padding: 8px;
      border: none;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    .checkboxes {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .checkboxes label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    button {
      background-color: #1db954;
      border: none;
      color: white;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #17a04b;
    }
    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
    @media (max-width: 600px) {
      .tabs {
        flex-direction: column;
      }
      .tab {
        margin: 5px 0;
      }
      .checkboxes {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>FreeTube</h1>
  <div class="tabs">
    <button class="tab" id="tabUnderground">Underground Clips</button>
    <button class="tab" id="tabTutorials">Tutorials</button>
  </div>
  <form id="uploadForm" enctype="multipart/form-data">
    <label for="title">Video Title</label>
    <input type="text" id="title" name="title" required placeholder="Video title" />
    <label for="combo">Trick/Combo Used</label>
    <input type="text" id="combo" name="combo" placeholder="Combo used (e.g. ATW HATW)" />
    <label for="video">Select Video File</label>
    <input type="file" id="video" name="video" accept="video/*" required />
    <div class="checkboxes">
      <label><input type="checkbox" id="isUnderground" /> Underground Clip</label>
      <label><input type="checkbox" id="isTutorial" /> Tutorial</label>
    </div>
    <button type="submit" id="uploadBtn">Upload</button>
  </form>
  <h2>Videos</h2>
  <div id="videos"></div>
</div>
<script>
const palabras_valores = {
   'XTB': 1, 'RXTB': 1, 'XTBV': 1, 'RXTBV': 1,
    'TB': 1, 'RTB': 1, 'TBV': 1,
    'XO': 1.5, 'RXO': 1.5, 'XOV': 1.5, 'RXOV': 1.5,
    'CO': 1.5, 'RCO': 1.5,
    'AXO': 1.5, 'ACO': 1.5, 'RACO': 1.5,
    'LAXO': 1.5, 'LACO': 1.5, 'RLACO': 1.5,
    'HATW': 1.5, 'RHATW': 1.5, 'HHTW': 1.5, 'RHHTW': 1.5,
    'ATW': 2, 'RATW': 2, 'HLATW': 2, 'HRLATW': 2,
    'HHTATW': 2, 'HHMATW': 2, 'HHJATW': 2, 'HRHJATW': 2,
    'HMG': 2, 'HMG in': 2, 'HMG out': 2, 'HRMG': 2,
    'HFMG': 2, 'HFMG in': 2, 'HFMG out': 2, 'HRFMG': 2,
    'MLATW': 2, 'RMLATW': 2,
    'HTW': 2.5, 'RHTW': 2.5,
    'AHLATW': 2.5, 'AHRLATW': 2.5,
    'AHHTATW': 2.5, 'AHHMATW': 2.5, 'AHHJATW': 2.5, 'AHRHJATW': 2.5,
    'HAMG': 2.5, 'HAMG in': 2.5, 'HAMG out': 2.5, 'HARMG': 2.5,
    'HAFMG': 2.5, 'HAFMG in': 2.5, 'HAFMG out': 2.5, 'HARFMG': 2.5,
    'AMLATW': 2.5, 'ARMLATW': 2.5,
    'RatATW': 3, 'RRatATW': 3, 'TATW': 3, 'MATW': 3,
    'JATW': 3, 'RJATW': 3, 'MLRRatATW': 3, 'RMLRatATW': 3,
    'MLMATW': 3, 'RMLTATW': 3, 'MLRJATW': 3, 'RMLJATW': 3,
    'ARatATW': 3.5, 'ARRatATW': 3.5, 'ATATW': 3.5, 'AMATW': 3.5,
    'AJATW': 3.5, 'ARJATW': 3.5, 'AMLRRatATW': 3.5, 'ARMLRatATW': 3.5,
    'AMLMATW': 3.5, 'ARMLTATW': 3.5, 'AMLRJATW': 3.5, 'ARMLJATW': 3.5,
    'LATW': 4, 'RLATW': 4, 'HTATW': 4, 'HMATW': 4, 'HJATW': 4,
    'RHJATW': 4, 'MG': 4, 'MG in': 4, 'MG out': 4, 'RMG': 4,
    'FMG': 4, 'FMG in': 4, 'FMG out': 4, 'RFMG': 4,
    'HTATW NJ': 4, 'HMATW NJ': 4, 'HJATW NJ': 4, 'RHJATW NJ': 4,
    'ALATW': 4.5, 'ARLATW': 4.5, 'AHTATW': 4.5, 'AHMATW': 4.5,
    'AHJATW': 4.5, 'ARHJATW': 4.5,
    'AMG': 4.5, 'AMG in': 4.5, 'AMG out': 4.5, 'ARMG': 4.5,
    'AFMG': 4.5, 'AFMG in': 4.5, 'AFMG out': 4.5, 'ARFMG': 4.5,
    'AHTATW NJ': 4.5, 'AHMATW NJ': 4.5, 'AHJATW NJ': 4.5, 'ARHJATW NJ': 4.5,
    'LRatATW': 5, 'LRRatATW': 5, 'LTATW': 5, 'LMATW': 5, 'LJATW': 5,
    'LRJATW': 5, 'PT': 5, 'RPT': 5, 'RSenATW': 5, 'SenATW': 5,
    'NM': 5, 'RNM': 5,
    'MGRRatATW': 5, 'MGRRatATW in': 5, 'MGRatATW': 5, 'RMGRatATW': 5,
    'MGMATW': 5, 'MGMATW in': 5, 'MGTATW': 5, 'RMGTATW': 5,
    'MGRJATW': 5, 'MGRJATW in': 5, 'MGJATW': 5, 'RMGJATW': 5,
    'FMGRRatATW': 5, 'FMGRRatATW in': 5, 'FMGRatATW': 5, 'RFMGRatATW': 5,
    'FMGMATW': 5, 'FMGMATW in': 5, 'FMGTATW': 5, 'RFMGTATW': 5,
    'FMGRJATW': 5, 'FMGRJATW in': 5, 'FMGJATW': 5, 'RFMGJATW': 5, 'FMGRJATW in': 5,
    'FMGJATW': 5, 'RFMGJATW': 5, 'PT NJ': 5, 'RPT NJ': 5, 'RSenATW NJ': 5, 'SenATW NJ': 5, 
    'NM NJ': 5, 'RNM NJ': 5, 'ALRatATW': 5.5, 'ALRRatATW': 5.5, 'ALTATW': 5.5, 'ALMATW': 5.5,
    'ALJATW': 5.5, 'ALRJATW': 5.5, 'RSATW': 5.5, 'SATW': 5.5, 'ARSenATW': 5.5, 'ASenATW': 5.5,
    'AMGRRatATW': 5.5, 'AMGRRatATW in': 5.5, 'AMGRatATW': 5.5, 'ARMGRatATW': 5.5, 'AMGMATW': 5.5,
    'AMGMATW in': 5.5, 'AMGTATW': 5.5, 'ARMGTATW': 5.5, 'AMGRJATW': 5.5, 'AMGRJATW in': 5.5,
    'AMGJATW': 5.5, 'ARMGJATW': 5.5, 'AFMGRRatATW': 5.5, 'AFMGRRatATW in': 5.5, 'AFMGRatATW': 5.5,
    'ARFMGRatATW': 5.5, 'AFMGMATW': 5.5, 'AFMGMATW in': 5.5, 'AFMGTATW': 5.5, 'ARFMGTATW': 5.5,
    'AFMGRJATW': 5.5, 'AFMGRJATW in': 5.5, 'AFMGJATW': 5.5, 'ARFMGJATW': 5.5, 'RSATW NJ': 5.5,
    'SATW NJ': 5.5, 'ARSenATW NJ': 5.5, 'ASenATW NJ': 5.5
};

function calculateScore(video) {
  const tricks = video.combo?.trim().split(/\s+/) || [];
  video.tricks = tricks;
  let total = 0;
  let unknown = false;
  tricks.forEach(t => {
    if (palabras_valores[t]) {
      total += palabras_valores[t];
    } else {
      unknown = true;
    }
  });
  video.puntajeCombo = total;
  video.desconocido = unknown;
}

function sortVideos() {
  const hasUnknown = videos.some(v => v.desconocido);
  if (hasUnknown) {
    videos.sort((a, b) => b.uploadedAt - a.uploadedAt || a.views - b.views);
  } else {
    videos.sort((a, b) => b.puntajeCombo - a.puntajeCombo || b.uploadedAt - a.uploadedAt || a.views - b.views);
  }
}

const videosDiv = document.getElementById('videos');
const tabTutorials = document.getElementById('tabTutorials');
const tabUnderground = document.getElementById('tabUnderground');
const uploadForm = document.getElementById('uploadForm');
const uploadBtn = document.getElementById('uploadBtn');
const isUndergroundCheckbox = document.getElementById('isUnderground');
const isTutorialCheckbox = document.getElementById('isTutorial');
const comboInput = document.getElementById('combo');

let videos = [];
let currentTab = 'underground';

function updateComboFieldState() {
  comboInput.disabled = isTutorialCheckbox.checked;
  if (isTutorialCheckbox.checked) comboInput.value = '';
}

isTutorialCheckbox.addEventListener('change', updateComboFieldState);
isUndergroundCheckbox.addEventListener('change', updateComboFieldState);

async function loadVideos() {
  const res = await fetch('/videos');
  const data = await res.json();
  videos = data.map(v => {
    v.uploadedAt = new Date(v.date).getTime();
    if (v.isUnderground && v.combo) calculateScore(v);
    return v;
  });
  sortVideos();
  renderVideos();
}

function renderVideos() {
  const filtered = currentTab === 'tutorials' ? videos.filter(v => v.isTutorial) : videos.filter(v => v.isUnderground);
  videosDiv.innerHTML = filtered.length === 0 ? '<p>No videos found.</p>' : '';

  filtered.forEach(video => {
    const div = document.createElement('div');
    div.className = 'video-item';
    const mailLink = `mailto:featuringia@gmail.com?subject=${encodeURIComponent("Solicitud de eliminación de video")}&body=${encodeURIComponent(`Hola,\n\nQuisiera solicitar la eliminación del siguiente video:\n\nTítulo: ${video.title}\n\nGracias.`)}`;

    div.innerHTML = `
      <p><strong>Title:</strong> ${video.title}</p>
      ${video.isUnderground && video.combo ? `<p><strong>Trick/Combo:</strong> ${video.combo}</p>` : ''}
      ${video.isUnderground && video.combo ? (video.desconocido ? `<p class="unknown">Punctuation: unknown</p>` : `<p><strong>Combo score:</strong> ${video.puntajeCombo.toFixed(2)}</p>`) : ''}
      <p><strong>Type:</strong> ${video.isTutorial ? 'Tutorial' : 'Underground Clip'}</p>
      <p><strong>Views:</strong> ${video.views || 0}</p>
      <p><strong>Uploaded:</strong> ${new Date(video.date).toLocaleString()}</p>
      <video controls src="${video.url}"></video>
      <a class="delete-button" href="${mailLink}">Solicitar eliminación</a>
    `;
    videosDiv.appendChild(div);
  });
}

uploadForm.addEventListener('submit', async function (e) {
  e.preventDefault();
  uploadBtn.disabled = true;
  const formData = new FormData(uploadForm);
  formData.append('isUnderground', isUndergroundCheckbox.checked);
  formData.append('isTutorial', isTutorialCheckbox.checked);

  try {
    const res = await fetch('/upload', { method: 'POST', body: formData });
    if (!res.ok) throw new Error('Error uploading video');
    await loadVideos();
    uploadForm.reset();
    updateComboFieldState();
  } catch (err) {
    alert(err.message);
  } finally {
    uploadBtn.disabled = false;
  }
});

tabTutorials.addEventListener('click', () => {
  currentTab = 'tutorials';
  tabTutorials.classList.add('active');
  tabUnderground.classList.remove('active');
  renderVideos();
});

tabUnderground.addEventListener('click', () => {
  currentTab = 'underground';
  tabUnderground.classList.add('active');
  tabTutorials.classList.remove('active');
  renderVideos();
});

tabUnderground.classList.add('active');
updateComboFieldState();
loadVideos();
</script>
</body>
</html>
